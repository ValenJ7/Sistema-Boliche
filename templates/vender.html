{% extends "base.html" %}
{% block title %}Vender Tragos{% endblock %}
{% block content %}

<!-- Volver arriba a la izquierda (fuera del wrapper centrado) -->
<div class="back-row" style="margin: 8px 0 0 24px;">
  <a href="{{ url_for('eventos') }}" class="btn btn-secondary btn-sm" style="padding:4px 8px; font-size:.85rem;">← Volver</a>
</div>

<!-- Wrapper centrado -->
<div class="sell-wrapper" style="max-width:980px; margin:0 auto;">

  <h2 style="text-align:center;">Vender — {{ evento.nombre }} ({{ evento.fecha }} {{ evento.hora }})</h2>

  <!-- mensajes -->
  <div class="flash-container" style="max-width:820px; margin: 12px auto;">
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, msg in messages %}
          <div class="flash flash-{{category}}">
            <span>{{ msg }}</span>
            <button class="flash-close" onclick="this.parentElement.style.display='none'">&times;</button>
          </div>
        {% endfor %}
      {% endif %}
    {% endwith %}
  </div>

  <form method="post" id="ventaForm" style="max-width:820px; margin: 0 auto;">
    <div class="table-wrap" style="overflow-x:auto;">
      <table class="table-sell" style="width:100%; border-collapse:collapse;">
        <thead>
          <tr>
            <th style="text-align:left; padding:12px 16px;">Trago</th>
            <th style="text-align:right; padding:12px 16px;">Precio</th>
            <th style="text-align:center; padding:12px 16px; width:220px;">Cantidad</th>
          </tr>
        </thead>
        <tbody>
          {% for t in catalogo %}
          <tr>
            <td style="padding:12px 16px;">{{ t.nombre }}</td>
            <td style="padding:12px 16px; text-align:right;">${{ "%.2f"|format(t.precio) }}</td>
            <td style="padding:12px 16px; text-align:center;">
              <div class="qty" style="display:flex; justify-content:center; align-items:center; gap:10px;">
                <button type="button" class="btn btn-sm btn-secondary btn-minus" data-id="{{ t.id }}" style="width:32px;height:32px;border-radius:50%;padding:0;">−</button>
                <span id="cant_{{ t.id }}">0</span>
                <button type="button" class="btn btn-sm btn-plus" data-id="{{ t.id }}" style="width:32px;height:32px;border-radius:50%;padding:0;">+</button>
                <input type="hidden" name="cantidad_{{ t.id }}" id="input_{{ t.id }}" value="0">
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <div style="margin:20px 0; text-align:center;">
      <h3 style="display:inline-block;">Total: $<span id="total">0.00</span></h3>
      <p id="resumenItems" style="opacity:.8; margin-top:6px;"></p>
    </div>

    <div class="actions" style="display:flex; flex-direction:column; gap:10px; max-width:820px; margin:0 auto;">
      <button type="submit" id="btnConfirmar" class="btn" disabled>Confirmar venta</button>
      <a href="{{ url_for('ver_tragos', event_id=evento.id) }}" class="btn btn-secondary">Ver registro</a>
    </div>
  </form>
</div>

<!-- JSON embebido -->
<script type="application/json" id="catalogo-json">{{ catalogo | tojson }}</script>

<script>
  const catalogo = JSON.parse(document.getElementById('catalogo-json').textContent);
  const precios = Object.fromEntries(catalogo.map(t => [t.id, t.precio]));
  const cantidades = Object.fromEntries(catalogo.map(t => [t.id, 0]));

  function render(id) {
    document.getElementById("cant_" + id).textContent = cantidades[id];
    document.getElementById("input_" + id).value = cantidades[id];
    actualizarTotal();
  }

  function actualizarTotal() {
    let total = 0, items = 0;
    for (const [id, qty] of Object.entries(cantidades)) {
      total += qty * precios[id];
      items += qty;
    }
    document.getElementById("total").textContent = total.toFixed(2);
    document.getElementById("btnConfirmar").disabled = total <= 0;
    document.getElementById("resumenItems").textContent = items > 0 ? `${items} ítem(s)` : '';
  }

  document.querySelectorAll(".btn-plus").forEach(btn => {
    btn.addEventListener("click", () => {
      const id = Number(btn.dataset.id);
      cantidades[id] = (cantidades[id] || 0) + 1;
      render(id);
    });
  });

  document.querySelectorAll(".btn-minus").forEach(btn => {
    btn.addEventListener("click", () => {
      const id = Number(btn.dataset.id);
      cantidades[id] = Math.max(0, (cantidades[id] || 0) - 1);
      render(id);
    });
  });

  actualizarTotal();
</script>
{% endblock %}
